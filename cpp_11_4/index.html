<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>[C&#43;&#43;]C&#43;&#43; 11/14 ç¬”è®°ï¼ˆå››ï¼‰ - å­æ’çš„åšå®¢</title><meta name="Description" content="æŠ€æœ¯|æ€è€ƒ"><meta property="og:title" content="[C&#43;&#43;]C&#43;&#43; 11/14 ç¬”è®°ï¼ˆå››ï¼‰" />
<meta property="og:description" content="æœ¬éƒ¨åˆ†ä»‹ç»äº†c&#43;&#43;11çš„å¹¶å‘ç¼–ç¨‹ã€‚è¿™äº›ç¬”è®°æ˜¯æœªå®Œæˆçš„ã€‚
è¯­æ³•å‚è€ƒè¿™é‡Œï¼š
ç°ä»£C&#43;&#43;æ•™ç¨‹
å®ç°å‚è€ƒè¿™é‡Œï¼š
C&#43;&#43;11ä¸­çš„mutex, lockï¼Œcondition variableå®ç°åˆ†æ
std::thread C&#43;&#43; 11ä¸ºæˆ‘ä»¬å¸¦æ¥äº†è¯­è¨€çº§çš„çº¿ç¨‹æ”¯æŒï¼ŒåŒ…æ‹¬çº¿ç¨‹çš„åˆ›å»ºå’Œç­‰å¾…ï¼š
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 //g&#43;&#43; -o t main.cpp -lpthread --std=c&#43;&#43;11 #include &lt;iostream&gt; #include &lt;thread&gt; #include &lt;chrono&gt; void foo(int sec) { // sleep_for() ä¼‘çœ secç§’åå”¤é†’ std::this_thread::sleep_for(std::chrono::seconds(sec)); } int main() { // join() é˜»å¡ç­‰å¾…çº¿ç¨‹ // joinable() æ˜¯å¦å¯ä»¥joinï¼ˆæ²¡è®¾ç½®ä»»åŠ¡å‡½æ•°ä¸å¯ä»¥joinï¼‰ std::thread t; std::cout &lt;&lt; &#34;before starting, joinable: &#34; &lt;&lt; t." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://chestnutheng.github.io/cpp_11_4/" /><meta property="og:image" content="http://chestnutheng.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-08-18T19:34:11+08:00" />
<meta property="article:modified_time" content="2021-02-02T20:24:08+08:00" /><meta property="og:site_name" content="å­æ’çš„åšå®¢" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://chestnutheng.github.io/logo.png"/>

<meta name="twitter:title" content="[C&#43;&#43;]C&#43;&#43; 11/14 ç¬”è®°ï¼ˆå››ï¼‰"/>
<meta name="twitter:description" content="æœ¬éƒ¨åˆ†ä»‹ç»äº†c&#43;&#43;11çš„å¹¶å‘ç¼–ç¨‹ã€‚è¿™äº›ç¬”è®°æ˜¯æœªå®Œæˆçš„ã€‚
è¯­æ³•å‚è€ƒè¿™é‡Œï¼š
ç°ä»£C&#43;&#43;æ•™ç¨‹
å®ç°å‚è€ƒè¿™é‡Œï¼š
C&#43;&#43;11ä¸­çš„mutex, lockï¼Œcondition variableå®ç°åˆ†æ
std::thread C&#43;&#43; 11ä¸ºæˆ‘ä»¬å¸¦æ¥äº†è¯­è¨€çº§çš„çº¿ç¨‹æ”¯æŒï¼ŒåŒ…æ‹¬çº¿ç¨‹çš„åˆ›å»ºå’Œç­‰å¾…ï¼š
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 //g&#43;&#43; -o t main.cpp -lpthread --std=c&#43;&#43;11 #include &lt;iostream&gt; #include &lt;thread&gt; #include &lt;chrono&gt; void foo(int sec) { // sleep_for() ä¼‘çœ secç§’åå”¤é†’ std::this_thread::sleep_for(std::chrono::seconds(sec)); } int main() { // join() é˜»å¡ç­‰å¾…çº¿ç¨‹ // joinable() æ˜¯å¦å¯ä»¥joinï¼ˆæ²¡è®¾ç½®ä»»åŠ¡å‡½æ•°ä¸å¯ä»¥joinï¼‰ std::thread t; std::cout &lt;&lt; &#34;before starting, joinable: &#34; &lt;&lt; t."/>
<meta name="application-name" content="æˆ‘çš„ç½‘ç«™">
<meta name="apple-mobile-web-app-title" content="æˆ‘çš„ç½‘ç«™"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://chestnutheng.github.io/cpp_11_4/" /><link rel="prev" href="http://chestnutheng.github.io/load_balance3/" /><link rel="next" href="http://chestnutheng.github.io/redis_1/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "[C++]C++ 11/14 ç¬”è®°ï¼ˆå››ï¼‰",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/chestnutheng.github.io\/cpp_11_4\/"
        },"genre": "posts","keywords": "c\u002b\u002b,  c\u002b\u002b11","wordcount":  893 ,
        "url": "http:\/\/chestnutheng.github.io\/cpp_11_4\/","datePublished": "2020-08-18T19:34:11+08:00","dateModified": "2021-02-02T20:24:08+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "å­æ’"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="å­æ’çš„åšå®¢">å­æ’çš„åšå®¢</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/"> ä¸»é¡µ </a><a class="menu-item" href="/posts/"> æ–‡ç«  </a><a class="menu-item" href="/tags/"> æ ‡ç­¾ </a><a class="menu-item" href="/categories/"> åˆ†ç±» </a><a class="menu-item" href="/freinds/"> å‹é“¾ </a><a class="menu-item" href="/about/"> å…³äº </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="å­æ’çš„åšå®¢">å­æ’çš„åšå®¢</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/" title="">ä¸»é¡µ</a><a class="menu-item" href="/posts/" title="">æ–‡ç« </a><a class="menu-item" href="/tags/" title="">æ ‡ç­¾</a><a class="menu-item" href="/categories/" title="">åˆ†ç±»</a><a class="menu-item" href="/freinds/" title="">å‹é“¾</a><a class="menu-item" href="/about/" title="">å…³äº</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">[C++]C++ 11/14 ç¬”è®°ï¼ˆå››ï¼‰</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="about" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>å­æ’</a></span>&nbsp;<span class="post-category">included in <a href="/categories/c++/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>C++</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2020-08-18">2020-08-18</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;893 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;5 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#stdthread">std::thread</a></li>
    <li><a href="#stdmutexå’Œstdlock_guardåŒæ­¥">std::mutexå’Œstd::lock_guardåŒæ­¥</a></li>
    <li><a href="#stdunique_lockç¼©å°é”çš„ç²’åº¦">std::unique_lockç¼©å°é”çš„ç²’åº¦</a></li>
    <li><a href="#stdfuture-æœŸç‰©">std::future æœŸç‰©</a></li>
    <li><a href="#åŸå­æ“ä½œ-stdatomic">åŸå­æ“ä½œ std::atomic</a></li>
    <li><a href="#æ¡ä»¶å˜é‡-stdcondition_variable">æ¡ä»¶å˜é‡ std::condition_variable</a></li>
    <li><a href="#å†…å­˜é¡ºåº">å†…å­˜é¡ºåº</a>
      <ul>
        <li><a href="#å®½æ¾æ¨¡å‹-relaxed">å®½æ¾æ¨¡å‹ relaxed</a></li>
        <li><a href="#é‡Šæ”¾æ¶ˆè´¹æ¨¡å‹-releaseconsume">é‡Šæ”¾/æ¶ˆè´¹æ¨¡å‹ release/consume</a></li>
        <li><a href="#é‡Šæ”¾è·å–æ¨¡å‹-releaseacquire">é‡Šæ”¾/è·å–æ¨¡å‹ release/acquire</a></li>
        <li><a href="#é¡ºåºä¸€è‡´æ¨¡å‹-sequential-consistency">é¡ºåºä¸€è‡´æ¨¡å‹ sequential consistency</a></li>
      </ul>
    </li>
    <li><a href="#å®ç°ä¸€ä¸ªçº¿ç¨‹æ± ">å®ç°ä¸€ä¸ªçº¿ç¨‹æ± </a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>æœ¬éƒ¨åˆ†ä»‹ç»äº†c++11çš„å¹¶å‘ç¼–ç¨‹ã€‚è¿™äº›ç¬”è®°æ˜¯æœªå®Œæˆçš„ã€‚</p>
<!-- more -->
<p>è¯­æ³•å‚è€ƒè¿™é‡Œï¼š<br>
<a href="https://changkun.de/modern-cpp/zh-cn/07-thread/index.html" target="_blank" rel="noopener noreffer ">ç°ä»£C++æ•™ç¨‹</a><br>
å®ç°å‚è€ƒè¿™é‡Œï¼š<br>
<a href="http://hengyunabc.github.io/cpp11-mutex-lock-condition/" target="_blank" rel="noopener noreffer ">C++11ä¸­çš„mutex, lockï¼Œcondition variableå®ç°åˆ†æ</a></p>
<h1 id="stdthread">std::thread</h1>
<p>C++ 11ä¸ºæˆ‘ä»¬å¸¦æ¥äº†è¯­è¨€çº§çš„çº¿ç¨‹æ”¯æŒï¼ŒåŒ…æ‹¬çº¿ç¨‹çš„åˆ›å»ºå’Œç­‰å¾…ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">//g++ -o t main.cpp -lpthread --std=c++11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;chrono&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">foo</span><span class="p">(</span><span class="kt">int</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sleep_for() ä¼‘çœ secç§’åå”¤é†’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="n">sec</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// join() é˜»å¡ç­‰å¾…çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// joinable() æ˜¯å¦å¯ä»¥joinï¼ˆæ²¡è®¾ç½®ä»»åŠ¡å‡½æ•°ä¸å¯ä»¥joinï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;before starting, joinable: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">t</span><span class="p">.</span><span class="n">joinable</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;after starting, joinable: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">t</span><span class="p">.</span><span class="n">joinable</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// detach() å°†å½“å‰çº¿ç¨‹å¯¹è±¡æ‰€ä»£è¡¨çš„æ‰§è¡Œå®ä¾‹ä¸è¯¥çº¿ç¨‹å¯¹è±¡åˆ†ç¦»ï¼Œä½¿å¾—çº¿ç¨‹çš„æ‰§è¡Œå¯ä»¥å•ç‹¬è¿›è¡Œã€‚ä¸€æ—¦çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå®ƒæ‰€åˆ†é…çš„èµ„æºå°†ä¼šè¢«é‡Šæ”¾ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ°¸è¿œä¸è¦ç”¨detach()ã€‚å¤±å»æ§åˆ¶çš„çº¿ç¨‹ä¼šæœ‰å¾ˆå¤šé—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// get_id() æ‰“å°çº¿ç¨‹id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nl">std</span><span class="p">:</span><span class="err">ğŸ§µ</span><span class="o">:</span><span class="n">id</span> <span class="n">t1_id</span> <span class="o">=</span> <span class="n">t1</span><span class="p">.</span><span class="n">get_id</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;t1_id: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">t1_id</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="stdmutexå’Œstdlock_guardåŒæ­¥">std::mutexå’Œstd::lock_guardåŒæ­¥</h1>
<p>æœ‰äº†çº¿ç¨‹å°±å¿…ç„¶éœ€è¦é”ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼Œç”¨RAII çš„æ–¹å¼ç®¡ç†çº¿ç¨‹å’Œé”ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// g++ -o t th.cpp --std=c++11 -lpthread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">critical_section</span><span class="p">(</span><span class="kt">int</span> <span class="n">change_v</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">mtx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ‰§è¡Œç«äº‰æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">v</span> <span class="o">=</span> <span class="n">change_v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç¦»å¼€æ­¤ä½œç”¨åŸŸå mtx ä¼šè¢«é‡Šæ”¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span><span class="p">(</span><span class="n">critical_section</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">t2</span><span class="p">(</span><span class="n">critical_section</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>çœ‹çœ‹æºç ï¼Œå¾ˆç®€å•åœ°ç”¨æ„é€ å’Œææ„åŒ…äº†ä¸€ä¸‹é”ï¼š</p>
<ol>
<li>å‘ç”Ÿå¼‚å¸¸æ—¶ä¹Ÿå¯ä»¥ææ„ï¼Œæ‰€ä»¥é”æ˜¯å¼‚å¸¸å®‰å…¨çš„</li>
<li>ç¦æ­¢æ‹·è´æ„é€ ã€èµ‹å€¼</li>
<li>é”çŠ¶æ€æ˜¯<code>adopt_lock_t</code>ï¼ˆå·²è·å¾—é”ï¼‰ï¼Œä¼šè°ƒç”¨ä¸åŠ é”çš„æ„é€ å‡½æ•°</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">_Mutex</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">lock_guard</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">typedef</span> <span class="n">_Mutex</span> <span class="n">mutex_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">mutex_type</span><span class="o">&amp;</span> <span class="n">__m_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">explicit</span> <span class="n">lock_guard</span><span class="p">(</span><span class="n">mutex_type</span><span class="o">&amp;</span> <span class="n">__m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span> <span class="n">__m_</span><span class="p">(</span><span class="n">__m</span><span class="p">)</span> <span class="p">{</span><span class="n">__m_</span><span class="p">.</span><span class="n">lock</span><span class="p">();}</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock_guard</span><span class="p">(</span><span class="n">mutex_type</span><span class="o">&amp;</span> <span class="n">__m</span><span class="p">,</span> <span class="n">adopt_lock_t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span> <span class="n">__m_</span><span class="p">(</span><span class="n">__m</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">lock_guard</span><span class="p">()</span> <span class="p">{</span><span class="n">__m_</span><span class="p">.</span><span class="n">unlock</span><span class="p">();}</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock_guard</span><span class="p">(</span><span class="n">lock_guard</span> <span class="k">const</span><span class="o">&amp;</span><span class="p">);</span><span class="c1">// = delete;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">lock_guard</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">lock_guard</span> <span class="k">const</span><span class="o">&amp;</span><span class="p">);</span><span class="c1">// = delete;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="stdunique_lockç¼©å°é”çš„ç²’åº¦">std::unique_lockç¼©å°é”çš„ç²’åº¦</h1>
<p>lock_guard æ˜¯ä¸€ç§RAIIçš„æ€æƒ³ç®¡ç†é”ï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦è‡ªå·±åŠ æ›´å°ç²’åº¦çš„é”ã€‚</p>
<ol>
<li>åŒæ ·ï¼Œæ„é€ æ—¶åŠ é”ï¼Œææ„æ—¶é‡Šæ”¾é”</li>
<li>æä¾›äº†lockã€unlockã€trylockã€releaseç­‰é¢å¤–çš„åŠŸèƒ½ï¼Œå½“ç„¶ï¼Œå¼€é”€ä¹Ÿæ›´å¤§</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">critical_section</span><span class="p">(</span><span class="kt">int</span> <span class="n">change_v</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">mtx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ‰§è¡Œç«äº‰æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">v</span> <span class="o">=</span> <span class="n">change_v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å°†é”è¿›è¡Œé‡Šæ”¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åœ¨æ­¤æœŸé—´ï¼Œä»»ä½•äººéƒ½å¯ä»¥æŠ¢å¤º v çš„æŒæœ‰æƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¼€å§‹å¦ä¸€ç»„ç«äº‰æ“ä½œï¼Œå†æ¬¡åŠ é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">v</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ææ„ä¹Ÿä¼šè‡ªåŠ¨é‡Šæ”¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="p">}</span>  
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="stdfuture-æœŸç‰©">std::future æœŸç‰©</h1>
<p>åœ¨ C++11 çš„ <code>std::future</code> è¢«å¼•å…¥ä¹‹å‰ï¼Œå¹¶è¡Œè·å–æ•°æ®çš„é€šå¸¸çš„åšæ³•æ˜¯ï¼š åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ Aï¼Œåœ¨çº¿ç¨‹ A é‡Œå¯åŠ¨ä»»åŠ¡ Bï¼Œå½“å‡†å¤‡å®Œæ¯•åå‘é€ä¸€ä¸ªäº‹ä»¶ï¼Œå¹¶å°†ç»“æœä¿å­˜åœ¨å…¨å±€å˜é‡ä¸­ã€‚ è€Œä¸»å‡½æ•°çº¿ç¨‹ A é‡Œæ­£åœ¨åšå…¶ä»–çš„äº‹æƒ…ï¼Œå½“éœ€è¦ç»“æœçš„æ—¶å€™ï¼Œè°ƒç”¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å‡½æ•°æ¥è·å¾—æ‰§è¡Œçš„ç»“æœã€‚</p>
<p>è€Œ C++11 æä¾›çš„ <code>std::future</code> ç®€åŒ–äº†è¿™ä¸ªæµç¨‹ï¼Œå¯ä»¥ç”¨æ¥è·å–å¼‚æ­¥ä»»åŠ¡çš„ç»“æœï¼š</p>
<ol>
<li>ä½¿ç”¨<code>packaged_task</code>æŠŠæˆ‘ä»¬çš„ä»»åŠ¡å‡½æ•°åŒ…èµ·æ¥å¾—åˆ°<code>task</code></li>
<li>è·å¾—æœŸç‰©<code>result=task.get_future()</code>ï¼ˆæ­¤æ—¶ä»–è¿˜æ²¡æœ‰ç»“æœï¼‰</li>
<li>åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œ<code>task</code></li>
<li>é˜»å¡ç­‰å¾…<code>result.wait()</code></li>
<li>è·å–ç»“æœ<code>result.get()</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;future&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å°†ä¸€ä¸ªè¿”å›å€¼ä¸º7çš„ lambda è¡¨è¾¾å¼å°è£…åˆ° task ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// std::packaged_task çš„æ¨¡æ¿å‚æ•°ä¸ºè¦å°è£…å‡½æ•°çš„ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">packaged_task</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">()</span><span class="o">&gt;</span> <span class="n">task</span><span class="p">([](){</span><span class="k">return</span> <span class="mi">7</span><span class="p">;});</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å¾— task çš„æœŸç‰©
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">get_future</span><span class="p">();</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œ task
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">task</span><span class="p">)).</span><span class="n">detach</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;waiting...&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span> <span class="c1">// åœ¨æ­¤è®¾ç½®å±éšœï¼Œé˜»å¡åˆ°æœŸç‰©çš„å®Œæˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¾“å‡ºæ‰§è¡Œç»“æœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;done!&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span> <span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;future result is &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="åŸå­æ“ä½œ-stdatomic">åŸå­æ“ä½œ std::atomic</h1>
<p>C++11 ä¸­å¤šçº¿ç¨‹ä¸‹å…±äº«å˜é‡çš„è¯»å†™è¿™ä¸€é—®é¢˜ä¸Šï¼Œè¿˜å¼•å…¥äº† std::atomic æ¨¡æ¿ï¼Œä½¿å¾—æˆ‘ä»¬å®ä¾‹åŒ–ä¸€ä¸ªåŸå­ç±»å‹ï¼Œå°†ä¸€ä¸ª åŸå­ç±»å‹è¯»å†™æ“ä½œä»ä¸€ç»„æŒ‡ä»¤ï¼Œæœ€å°åŒ–åˆ°å•ä¸ª CPU æŒ‡ä»¤ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;atomic&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">count</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span><span class="p">([](){</span>
</span></span><span class="line"><span class="cl">        <span class="n">count</span><span class="p">.</span><span class="n">fetch_add</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span><span class="p">([](){</span>
</span></span><span class="line"><span class="cl">        <span class="n">count</span><span class="o">++</span><span class="p">;</span>        <span class="c1">// ç­‰ä»·äº fetch_add
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>     <span class="c1">// ç­‰ä»·äº fetch_add
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">count</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="æ¡ä»¶å˜é‡-stdcondition_variable">æ¡ä»¶å˜é‡ std::condition_variable</h1>
<p>æ¡ä»¶å˜é‡ std::condition_variable æ˜¯ä¸ºäº†è§£å†³æ­»é”è€Œç”Ÿï¼Œå½“äº’æ–¥æ“ä½œä¸å¤Ÿç”¨è€Œå¼•å…¥çš„ã€‚ æ¯”å¦‚ï¼Œçº¿ç¨‹å¯èƒ½éœ€è¦ç­‰å¾…æŸä¸ªæ¡ä»¶ä¸ºçœŸæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œ è€Œä¸€ä¸ªå¿™ç­‰å¾…å¾ªç¯ä¸­å¯èƒ½ä¼šå¯¼è‡´æ‰€æœ‰å…¶ä»–çº¿ç¨‹éƒ½æ— æ³•è¿›å…¥ä¸´ç•ŒåŒºä½¿å¾—æ¡ä»¶ä¸ºçœŸæ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ­»é”ã€‚ æ‰€ä»¥ï¼Œcondition_variable å®ä¾‹è¢«åˆ›å»ºå‡ºç°ä¸»è¦å°±æ˜¯ç”¨äºå”¤é†’ç­‰å¾…çº¿ç¨‹ä»è€Œé¿å…æ­»é”ã€‚ std::condition_variableçš„ notify_one() ç”¨äºå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼› notify_all() åˆ™æ˜¯é€šçŸ¥æ‰€æœ‰çº¿ç¨‹ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å‹çš„ä¾‹å­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;queue&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;chrono&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;mutex&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;condition_variable&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">produced_nums</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">mtx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span> <span class="n">cv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">notified</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>  <span class="c1">// é€šçŸ¥ä¿¡å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç”Ÿäº§è€…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">producer</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">900</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;producing &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">produced_nums</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">notified</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">cv</span><span class="p">.</span><span class="n">notify_all</span><span class="p">();</span> <span class="c1">// æ­¤å¤„ä¹Ÿå¯ä»¥ä½¿ç”¨ notify_one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ¶ˆè´¹è€…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">consumer</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">notified</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// é¿å…è™šå‡å”¤é†’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">cv</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// çŸ­æš‚å–æ¶ˆé”ï¼Œä½¿å¾—ç”Ÿäº§è€…æœ‰æœºä¼šåœ¨æ¶ˆè´¹è€…æ¶ˆè´¹ç©ºå‰ç»§ç»­ç”Ÿäº§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span> <span class="c1">// æ¶ˆè´¹è€…æ…¢äºç”Ÿäº§è€…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">produced_nums</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;consuming &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">produced_nums</span><span class="p">.</span><span class="n">front</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">produced_nums</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">notified</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ†åˆ«åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¿è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">p</span><span class="p">(</span><span class="n">producer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">cs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">consumer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="å†…å­˜é¡ºåº">å†…å­˜é¡ºåº</h1>
<p>ä¸¤ä¸ªçº¿ç¨‹è¯»å†™ä¸´ç•ŒåŒºå˜é‡çš„æ—¶å€™ï¼Œè™½ç„¶åŠ é”å¯ä»¥ä¿è¯åŸå­æ“ä½œï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯åŸå­æ“ä½œçš„é¡ºåºã€‚ä¸€èˆ¬æ¥è®²ï¼Œæˆ‘ä»¬ä¹Ÿä¸éœ€è¦å…³æ³¨åŸå­æ“ä½œçš„é¡ºåºï¼Œå¦‚æœéœ€è¦å…³æ³¨ï¼Œé‚£å°±è¯·ç”¨æœ€å¼ºçš„å¼ºä¸€è‡´å†…å­˜æ¨¡å‹ï¼Œè€Œä¸æ˜¯åƒè¯­è¨€é‚£æ ·é‡‡ç”¨å…­ç§é¡ºåºæ¨¡å‹ï¼ˆå·¥ç¨‹é‡Œä¼šå¸¦æ¥ä¸å¿…è¦çš„å¤æ‚åº¦å’Œé”™è¯¯ä½¿ç”¨çš„é£é™©ï¼‰ã€‚<br>
C++11 ä¸ºäº†è¿½æ±‚æè‡´çš„æ€§èƒ½ï¼Œå®ç°å„ç§å¼ºåº¦è¦æ±‚çš„ä¸€è‡´æ€§ï¼Œä¸ºåŸå­æ“ä½œå®šä¹‰äº†å…­ç§ä¸åŒçš„å†…å­˜é¡ºåº std::memory_order çš„é€‰é¡¹ï¼Œè¡¨è¾¾äº†å››ç§å¤šçº¿ç¨‹é—´çš„åŒæ­¥æ¨¡å‹<br>
<a href="https://www.zhihu.com/question/24301047" target="_blank" rel="noopener noreffer ">https://www.zhihu.com/question/24301047</a></p>
<h2 id="å®½æ¾æ¨¡å‹-relaxed">å®½æ¾æ¨¡å‹ relaxed</h2>
<p>åœ¨æ­¤æ¨¡å‹ä¸‹ï¼Œ<strong>å•ä¸ªçº¿ç¨‹å†…çš„åŸå­æ“ä½œéƒ½æ˜¯é¡ºåºæ‰§è¡Œ</strong>çš„ï¼Œä¸å…è®¸æŒ‡ä»¤é‡æ’ï¼Œä½†<strong>ä¸åŒçº¿ç¨‹é—´åŸå­æ“ä½œçš„é¡ºåºæ˜¯ä»»æ„</strong>çš„ã€‚ç±»å‹é€šè¿‡ <code>std::memory_order_relaxed</code> æŒ‡å®šã€‚<br>
ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹å†…çš„<code>fetch_add</code>éƒ½æ˜¯é¡ºåºæ‰§è¡Œï¼Œä½†ä¸åŒçº¿ç¨‹é—´çš„<code>fetch_add</code>é¡ºåºæ˜¯ä¹±åºçš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">counter</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">vt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">vt</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](){</span>
</span></span><span class="line"><span class="cl">        <span class="n">counter</span><span class="p">.</span><span class="n">fetch_add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">t</span> <span class="p">:</span> <span class="n">vt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;current counter:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">counter</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="é‡Šæ”¾æ¶ˆè´¹æ¨¡å‹-releaseconsume">é‡Šæ”¾/æ¶ˆè´¹æ¨¡å‹ release/consume</h2>
<p>åœ¨æ­¤æ¨¡å‹ä¸­ï¼ŒåŠ äº†ä¸€ä¸ªé™åˆ¶ï¼Œ<strong>ä»»ä½•ä¸€æ¬¡è¯»æ“ä½œéƒ½èƒ½è¯»åˆ°æ•°æ®æœ€è¿‘ä¸€æ¬¡å†™å…¥</strong>çš„æ•°æ®ã€‚<br>
æ¯”å¦‚çº¿ç¨‹Aå†™äº†ä¸‰æ¬¡ï¼ŒBçº¿ç¨‹æ¥è¯»ï¼Œå¿…é¡»ä¿è¯Bçº¿ç¨‹çœ‹åˆ°çš„æ˜¯æœ€åä¸€æ¬¡ã€‚Açº¿ç¨‹å†™çš„é¡ºåºåˆ™ä¸ä½œè¦æ±‚ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// åˆå§‹åŒ–ä¸º nullptr é˜²æ­¢ consumer çº¿ç¨‹ä»é‡æŒ‡é’ˆè¿›è¡Œè¯»å–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">*&gt;</span> <span class="n">ptr</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">producer</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">v</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ptr</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">consumer</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span><span class="o">*</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_consume</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;p: &#34;</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">p</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;v: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="n">producer</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">consumer</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="é‡Šæ”¾è·å–æ¨¡å‹-releaseacquire">é‡Šæ”¾/è·å–æ¨¡å‹ release/acquire</h2>
<p>åœ¨æ­¤æ¨¡å‹ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥åŠ ç´§å¯¹ä¸åŒçº¿ç¨‹é—´åŸå­æ“ä½œçš„é¡ºåºçš„é™åˆ¶ã€‚release/acquireæ¨¡å‹ä¿è¯äº†çº¿ç¨‹ A ä¸­æ‰€æœ‰å‘ç”Ÿåœ¨ release x ä¹‹å‰çš„å†™æ“ä½œï¼Œå¯¹åœ¨çº¿ç¨‹ B acquire x ä¹‹åçš„ä»»ä½•è¯»æ“ä½œéƒ½å¯è§ã€‚<br>
<code>std::memory_order_release</code>ç¡®ä¿äº†å®ƒä¹‹åçš„å†™è¡Œä¸ºä¸ä¼šå‘ç”Ÿåœ¨é‡Šæ”¾æ“ä½œä¹‹å‰ï¼Œæ˜¯ä¸€ä¸ªå‘å‰çš„å±éšœ<br>
<code>std::memory_order_acquire</code>ç¡®ä¿äº†å®ƒä¹‹å‰çš„å†™è¡Œä¸ºï¼Œä¸ä¼šå‘ç”Ÿåœ¨è¯¥è·å–æ“ä½œä¹‹åï¼Œæ˜¯ä¸€ä¸ªå‘åçš„å±éšœ<br>
<code>std::memory_order_acq_rel</code>åˆ™ç»“åˆäº†è¿™ä¸¤è€…çš„ç‰¹ç‚¹ï¼Œå”¯ä¸€ç¡®å®šäº†ä¸€ä¸ªå†…å­˜å±éšœï¼Œä½¿å¾—å½“å‰çº¿ç¨‹å¯¹å†…å­˜çš„è¯»å†™ä¸ä¼šè¢«é‡æ’åˆ°æ­¤æ“ä½œçš„å‰åã€‚</p>
<h2 id="é¡ºåºä¸€è‡´æ¨¡å‹-sequential-consistency">é¡ºåºä¸€è‡´æ¨¡å‹ sequential consistency</h2>
<p>åœ¨æ­¤æ¨¡å‹ä¸‹ï¼ŒåŸå­æ“ä½œæ»¡è¶³é¡ºåºä¸€è‡´æ€§ï¼Œè¿›è€Œå¯èƒ½å¯¹æ€§èƒ½äº§ç”ŸæŸè€—ã€‚å¯æ˜¾å¼çš„é€šè¿‡ <code>std::memory_order_seq_cst</code> è¿›è¡ŒæŒ‡å®šã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">counter</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">vt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">vt</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](){</span>
</span></span><span class="line"><span class="cl">        <span class="n">counter</span><span class="p">.</span><span class="n">fetch_add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_seq_cst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">t</span> <span class="p">:</span> <span class="n">vt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;current counter:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">counter</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="å®ç°ä¸€ä¸ªçº¿ç¨‹æ± ">å®ç°ä¸€ä¸ªçº¿ç¨‹æ± </h1>
<p>æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­<a href="https://github.com/progschj/ThreadPool/blob/master/ThreadPool.h" target="_blank" rel="noopener noreffer ">C++11çº¿ç¨‹æ± </a>å­¦ä¹ ä¸€ä¸‹c11æä¾›çš„è¿™äº›æ–°ç‰¹æ€§ã€‚</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2021-02-02</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/cpp_11_4/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://chestnutheng.github.io/cpp_11_4/" data-title="[C&#43;&#43;]C&#43;&#43; 11/14 ç¬”è®°ï¼ˆå››ï¼‰" data-hashtags="c&#43;&#43;, c&#43;&#43;11"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://chestnutheng.github.io/cpp_11_4/" data-hashtag="c&#43;&#43;"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://chestnutheng.github.io/cpp_11_4/" data-title="[C&#43;&#43;]C&#43;&#43; 11/14 ç¬”è®°ï¼ˆå››ï¼‰"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://chestnutheng.github.io/cpp_11_4/" data-title="[C&#43;&#43;]C&#43;&#43; 11/14 ç¬”è®°ï¼ˆå››ï¼‰"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on å¾®åš" data-sharer="weibo" data-url="http://chestnutheng.github.io/cpp_11_4/" data-title="[C&#43;&#43;]C&#43;&#43; 11/14 ç¬”è®°ï¼ˆå››ï¼‰" data-ralateuid="2461859532"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/c&#43;&#43;/">c&#43;&#43;</a>,&nbsp;<a href="/tags/c&#43;&#43;11/"> c&#43;&#43;11</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/load_balance3/" class="prev" rel="prev" title="[åå°]è´Ÿè½½å‡è¡¡ ï¼ˆä¸‰ï¼‰é™æµç¯‡"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>[åå°]è´Ÿè½½å‡è¡¡ ï¼ˆä¸‰ï¼‰é™æµç¯‡</a>
            <a href="/redis_1/" class="next" rel="next" title="[Redis]Redis åº”ç”¨ç¯‡">[Redis]Redis åº”ç”¨ç¯‡<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="giscus" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://giscus.app">Giscus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.118.2">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2015 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="about" target="_blank">å­æ’</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{"giscus":{"category":"Announcements","categoryId":"DIC_kwDOA9ikP84CQT5Y","darkTheme":"dark","emitMetadata":"0","inputPosition":"bottom","lang":"en","lazyLoading":true,"lightTheme":"light","mapping":"pathname","reactionsEnabled":"1","repo":"chestnutheng/chestnutheng.github.io","repoId":"MDEwOlJlcG9zaXRvcnk2NDUyOTQ3MQ=="}},"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
